<form [formGroup]="form" (ngSubmit)="submit()">

  <div [class]="className">
    <ng-container *ngFor="let field of visibleFields()">

      <div [class]="field.className">
        <label class="block mb-1 font-medium">{{ field.label }}</label>

        <!-- TEXT -->
        <input *ngIf="field.type === 'text'"
               pInputText
               [formControlName]="field.name"
               [placeholder]="field.label"
               [disabled]="field.disabled"
               class="w-full"
               (blur)="form.get(field.name)?.markAsTouched()" />

        <!-- NUMBER -->
        <p-inputNumber *ngIf="field.type === 'number'"
                       [formControlName]="field.name"
                       [disabled]="field.disabled"
                       class="w-full"
                       (onBlur)="form.get(field.name)?.markAsTouched()"></p-inputNumber>

        <!-- PASSWORD -->
        <p-password *ngIf="field.type === 'password'"
                    toggleMask
                    [formControlName]="field.name"
                    [disabled]="field.disabled"
                    (onBlur)="form.get(field.name)?.markAsTouched()"></p-password>

        <!-- DATE -->
        <p-datePicker *ngIf="field.type === 'date'"
                      [formControlName]="field.name"
                      [disabled]="field.disabled"
                      (onBlur)="form.get(field.name)?.markAsTouched()"></p-datePicker>

        <!-- TEXTAREA -->
        <textarea *ngIf="field.type === 'textarea'"
                  pTextarea
                  rows="4"
                  [formControlName]="field.name"
                  [disabled]="field.disabled"
                  class="w-full"
                  (blur)="form.get(field.name)?.markAsTouched()"></textarea>

        <!-- CHECKBOX -->
        <p-checkbox *ngIf="field.type === 'checkbox'"
                    binary="true"
                    [formControlName]="field.name"
                    [disabled]="field.disabled"></p-checkbox>

        <!-- SWITCH -->
        <p-toggleSwitch *ngIf="field.type === 'switch'"
                        [formControlName]="field.name"
                        [disabled]="field.disabled"></p-toggleSwitch>

        <!-- SELECT -->
        <p-select *ngIf="field.type === 'select'"
                  [options]="field.options"
                  [formControlName]="field.name"
                  [disabled]="field.disabled"
                  [optionLabel]="field.optionLabel??'id'"
                  class="w-full"
                  appendTo="body"
                  (onBlur)="form.get(field.name)?.markAsTouched()"></p-select>

        <!-- SERVER SELECT -->
        <app-single-select *ngIf="field.type === 'server-select'"
                           [url]="field.url"
                           [disabled]="field.disabled"
                           [optionLabel]="field.optionLabel??'id'"
                           [optionValue]="field.optionValue ?? 'name'"
                           (valueChange)="handleSelectChange(field, $event)">
        </app-single-select>

        <!-- MULTI SELECT -->
        <app-multi-selected *ngIf="field.type === 'multi-select'"
                            [url]="field?.url??''"
                            [disabled]="field.disabled"
                            [optionLabel]="field.optionLabel??'id'"
                            (valueChange)="handleSelectChange(field, $event)">
        </app-multi-selected>

        <!-- FILE -->
        <input *ngIf="field.type === 'file'" type="file"
               (change)="form.get(field.name)?.setValue($any($event.target).files[0])"
               [disabled]="field.disabled">

        <!-- DIV (Label Only) -->
        <p *ngIf="field.type === 'div'">{{ field.label }}</p>

        <!-- ERROR MESSAGES -->
        <div *ngIf="isInvalid(field.name)" class="text-red-600 text-sm mt-1">
          <small *ngIf="form.get(field.name)?.errors?.['required']">
            {{ field.label || field.name }} is required
          </small>
          <small *ngIf="form.get(field.name)?.errors?.['minlength']">
            Minimum length is {{ form.get(field.name)?.errors?.['minlength'].requiredLength }}
          </small>
          <small *ngIf="form.get(field.name)?.errors?.['maxlength']">
            Maximum length is {{ form.get(field.name)?.errors?.['maxlength'].requiredLength }}
          </small>
          <small *ngIf="form.get(field.name)?.errors?.['pattern']">
            Invalid format
          </small>
          <small *ngIf="form.get(field.name)?.errors?.['min']">
            Minimum value is {{ form.get(field.name)?.errors?.['min'].min }}
          </small>
          <small *ngIf="form.get(field.name)?.errors?.['max']">
            Maximum value is {{ form.get(field.name)?.errors?.['max'].max }}
          </small>
        </div>

      </div>
    </ng-container>
  </div>

  <!-- SUBMIT BUTTON -->
  <div class="mt-4">
    <button pButton type="submit"
            label="Submit"
            [loading]="loading"
            [disabled]="loading">
    </button>
  </div>

  <!-- PROGRESS BAR -->
  <p-progressBar *ngIf="progress" [value]="percent"></p-progressBar>
</form>
